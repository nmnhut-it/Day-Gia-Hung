<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grade 6 - Unit 3: My Friends | English Grammar Games</title>
  <meta name="description" content="Practice Present Continuous tense and appearance adjectives for Grade 6">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="../css/shared.css">
</head>
<body>
  <!-- Game Header -->
  <header class="game-header">
    <div class="container">
      <div class="game-header__container">
        <div class="game-header__info-section">
          <h1 class="game-header__title">Grade 6 - Unit 3: My Friends</h1>
          <p class="game-header__subtitle">Present Continuous Tense & Appearance Adjectives</p>
          <div class="game-info">
            <div class="game-info__item">
              <span class="game-info__label">Gi√°o vi√™n:</span>
              <span class="game-info__value">Nguy·ªÖn Minh Nh·ª±t</span>
            </div>
            <div class="game-info__item">
              <span class="game-info__label">H·ªçc sinh:</span>
              <span class="game-info__value">L·ªõp 6</span>
            </div>
          </div>
        </div>

        <div class="game-header__stats">
          <div class="stat">
            <span class="stat__label">ƒêi·ªÉm</span>
            <span class="stat__value stat__value--primary" id="current-score">‚≠ê 0</span>
          </div>

          <div class="stat">
            <span class="stat__label">Ti·∫øn ƒë·ªô</span>
            <span class="stat__value" id="progress-count">0 / 0</span>
          </div>

          <div class="stat" id="combo-display" style="display: none;">
            <span class="stat__label">Combo</span>
            <span class="stat__value" id="combo-count">0</span>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress">
        <div class="progress__bar" id="progress-bar" style="width: 0%;"></div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Theory Panel (Collapsible) -->
    <div class="theory-panel" id="theory-panel">
      <button class="theory-panel__toggle" id="theory-toggle">
        <span>üìñ T√†i li·ªáu ng·ªØ ph√°p</span>
        <span class="theory-panel__icon" id="theory-icon">‚ñº</span>
      </button>

      <div class="theory-panel__content" id="theory-content">
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">1. Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn (Present Continuous Tense)</h3>
          <p><strong>C√¥ng th·ª©c:</strong></p>
          <ul>
            <li><strong>Kh·∫≥ng ƒë·ªãnh:</strong> S + am/is/are + V-ing</li>
            <li><strong>Ph·ªß ƒë·ªãnh:</strong> S + am/is/are + not + V-ing</li>
            <li><strong>Nghi v·∫•n:</strong> Am/Is/Are + S + V-ing?</li>
          </ul>

          <p><strong>C√°ch chia am/is/are:</strong></p>
          <ul>
            <li><strong>I</strong> ‚Üí am</li>
            <li><strong>He/She/It/1 ng∆∞·ªùi/1 v·∫≠t</strong> ‚Üí is</li>
            <li><strong>You/We/They/nhi·ªÅu ng∆∞·ªùi/nhi·ªÅu v·∫≠t</strong> ‚Üí are</li>
          </ul>

          <div class="theory-panel__example">
            <strong>V√≠ d·ª•:</strong><br>
            ‚Ä¢ I <strong>am learning</strong> English now. (T√¥i ƒëang h·ªçc ti·∫øng Anh b√¢y gi·ªù.)<br>
            ‚Ä¢ She <strong>is reading</strong> a book. (C√¥ ·∫•y ƒëang ƒë·ªçc s√°ch.)<br>
            ‚Ä¢ They <strong>are not playing</strong> football. (H·ªç kh√¥ng ƒëang ch∆°i b√≥ng ƒë√°.)<br>
            ‚Ä¢ <strong>Are</strong> you listening to music? (B·∫°n ƒëang nghe nh·∫°c ph·∫£i kh√¥ng?)
          </div>

          <p class="text-note"><strong>L∆∞u √Ω:</strong> are not = aren't, is not = isn't</p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">2. D·∫•u hi·ªáu nh·∫≠n bi·∫øt Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn</h3>
          <ul>
            <li><strong>now</strong> (b√¢y gi·ªù)</li>
            <li><strong>at the moment / at present</strong> (v√†o l√∫c n√†y)</li>
            <li><strong>Look!</strong> (Nh√¨n k√¨a!)</li>
            <li><strong>Listen!</strong> (Nghe k√¨a!)</li>
          </ul>
          <p>Nh·ªØng t·ª´ n√†y cho bi·∫øt h√†nh ƒë·ªông ƒëang di·ªÖn ra ngay l√∫c n√≥i.</p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">3. So s√°nh Th√¨ Hi·ªán T·∫°i ƒê∆°n v√† Hi·ªán T·∫°i Ti·∫øp Di·ªÖn</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="background: var(--bg-light);">
              <th style="padding: 8px; text-align: left;">Hi·ªán T·∫°i ƒê∆°n</th>
              <th style="padding: 8px; text-align: left;">Hi·ªán T·∫°i Ti·∫øp Di·ªÖn</th>
            </tr>
            <tr>
              <td style="padding: 8px;">Th√≥i quen, l·∫∑p ƒëi l·∫∑p l·∫°i</td>
              <td style="padding: 8px;">H√†nh ƒë·ªông ƒëang x·∫£y ra</td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 8px;">every day, always, usually, often</td>
              <td style="padding: 8px;">now, at the moment, Look!, Listen!</td>
            </tr>
            <tr>
              <td style="padding: 8px;">She <strong>walks</strong> to school every day.</td>
              <td style="padding: 8px;">She <strong>is walking</strong> to school now.</td>
            </tr>
          </table>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">4. T√≠nh t·ª´ mi√™u t·∫£ ngo·∫°i h√¨nh (Appearance)</h3>
          <p><strong>C·∫•u tr√∫c:</strong> S + have/has + (a/an) + t√≠nh t·ª´ + danh t·ª´</p>
          <ul>
            <li><strong>Hair (t√≥c):</strong> long (d√†i), short (ng·∫Øn), black (ƒëen), blonde (v√†ng)</li>
            <li><strong>Eyes (m·∫Øt):</strong> big (to), small (nh·ªè), brown (n√¢u), blue (xanh)</li>
            <li><strong>Face (m·∫∑t):</strong> round (tr√≤n), oval (tr√°i xoan)</li>
            <li><strong>Nose (m≈©i):</strong> big (to), small (nh·ªè)</li>
          </ul>
          <p><strong>V√≠ d·ª•:</strong> She has long black hair. / He has big brown eyes.</p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">5. T√≠nh t·ª´ mi√™u t·∫£ t√≠nh c√°ch (Personality)</h3>
          <p><strong>C·∫•u tr√∫c:</strong> S + am/is/are + t√≠nh t·ª´</p>
          <ul>
            <li><strong>friendly</strong> (th√¢n thi·ªán)</li>
            <li><strong>kind</strong> (t·ªët b·ª•ng)</li>
            <li><strong>hard-working</strong> (chƒÉm ch·ªâ)</li>
            <li><strong>creative</strong> (s√°ng t·∫°o)</li>
            <li><strong>funny</strong> (h√†i h∆∞·ªõc)</li>
            <li><strong>clever</strong> (th√¥ng minh)</li>
            <li><strong>confident</strong> (t·ª± tin)</li>
            <li><strong>caring</strong> (chu ƒë√°o)</li>
          </ul>
          <p><strong>V√≠ d·ª•:</strong> My friend is very friendly and kind.</p>
        </div>
      </div>
    </div>

    <!-- Exercise Container -->
    <div id="exercise-container">
      <!-- Exercises will be rendered here dynamically -->
      <div class="card text-center">
        <h2>Loading...</h2>
        <p>Please wait while we load the exercises.</p>
      </div>
    </div>
  </main>

  <!-- Core JavaScript (loaded first) -->
  <script src="../js/core/utils.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/core/telegram-sender.js"></script>
  <script src="../js/core/game-engine.js"></script>

  <!-- Exercise Type Handlers (mobile-friendly types only) -->
  <script src="../js/exercises/fill-blank.js"></script>
  <script src="../js/exercises/multiple-choice.js"></script>
  <script src="../js/exercises/word-rearrange.js"></script>

  <!-- Initialize Game -->
  <script>
    const UNIT_ID = 'g6-unit-3-my-friends';
    const DATA_PATH = '../data/g6-unit-3-my-friends.json';

    // Theory panel toggle
    const theoryToggle = document.getElementById('theory-toggle');
    const theoryContent = document.getElementById('theory-content');
    const theoryIcon = document.getElementById('theory-icon');

    theoryToggle.addEventListener('click', () => {
      const isExpanded = theoryContent.classList.contains('theory-panel__content--expanded');

      if (isExpanded) {
        theoryContent.classList.remove('theory-panel__content--expanded');
        theoryIcon.classList.remove('theory-panel__icon--rotated');
      } else {
        theoryContent.classList.add('theory-panel__content--expanded');
        theoryIcon.classList.add('theory-panel__icon--rotated');
      }
    });

    // Combo display logic
    function updateComboDisplay() {
      const comboDisplay = document.getElementById('combo-display');
      const comboCount = document.getElementById('combo-count');
      const state = GameEngine.getState();

      if (state.comboCount >= 3) {
        comboDisplay.style.display = 'flex';
        comboCount.textContent = state.comboCount + 'x üî•';
      } else {
        comboDisplay.style.display = 'none';
      }
    }

    // Override GameEngine.updateUI to include combo display
    const originalUpdateUI = GameEngine.updateUI.bind(GameEngine);
    GameEngine.updateUI = function() {
      originalUpdateUI();
      updateComboDisplay();
    };

    // Load unit data and start game
    async function loadAndStartGame() {
      try {
        const response = await fetch(DATA_PATH);

        if (!response.ok) {
          throw new Error(`Failed to load data: ${response.status}`);
        }

        const unitData = await response.json();

        console.log('Unit data loaded:', unitData);
        console.log('Registered exercise handlers:', Object.keys(GameEngine.exerciseHandlers));

        GameEngine.init(unitData, UNIT_ID);

      } catch (error) {
        console.error('Error loading game data:', error);

        const container = document.getElementById('exercise-container');
        container.innerHTML = `
          <div class="card">
            <h2 style="color: var(--danger);">Error Loading Game</h2>
            <p>Sorry, we couldn't load the exercise data. Please try refreshing the page.</p>
            <p style="font-size: var(--font-size-sm); color: var(--text-light);">Error: ${error.message}</p>
            <button class="btn btn--primary mt-2" onclick="location.reload()">Reload Page</button>
          </div>
        `;
      }
    }

    // Start game when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAndStartGame);
    } else {
      loadAndStartGame();
    }
  </script>
</body>
</html>
